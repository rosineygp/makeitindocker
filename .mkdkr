#!/bin/bash

_prn_exec() {
  echo -e "\e[32m${*}\e[0m"
}

_prn_warn() {
  echo -e "\e[33m${*}\e[0m"
}

_image() {
  docker ps | grep "${1}" | awk '{print $2}'
}

_launch() {
  CONTAINER_NAME="${1}"
  IMAGE="${2}"
  COMMAND="${3}"
  ARGS="${*:4}"

  docker run --rm -d \
    --name "${CONTAINER_NAME}" \
    --entrypoint "" \
    -v "${PWD}":"${PWD}" \
    --workdir "${PWD}" \
    ${ARGS[@]} \
    "${IMAGE}" ${COMMAND}
}

_service() {
  CONTAINER_NAME="${1}"
  IMAGE="${2}"
  ARGS="${*:3}"

  docker run --rm -d \
    --name "${CONTAINER_NAME}" \
    -v "${PWD}":"${PWD}" \
    --workdir "${PWD}" \
    ${ARGS} \
    "${IMAGE}"
}

....() {
  if [ -z "${JOB_NAME}" ]; then
    _JOB_NAME=$(echo "${1}_$(cat /proc/sys/kernel/random/uuid)" | sed 's/\//_/g')
    export JOB_NAME="${_JOB_NAME}"
  fi
  echo "${JOB_NAME}"
}

# shellcheck disable=SC1036
...() {
  TYPE="${1}"
  IMAGE="${2}"
  ARGS="${*:3}"
  COMMAND="sleep ${MKDKR_TTL:-3600}"

  if [ "${TYPE}" != "job" ] &&
    [ "${TYPE}" != "service" ] &&
    [ "${TYPE}" != "privileged" ]; then
    ARGS="${*:2}"
    IMAGE="${TYPE}"
    TYPE="job"
  fi

  if [ "$(docker ps | grep job_${JOB_NAME})" != "" ]; then
    _prn_warn "image changed, from: $(_image job_${JOB_NAME}) to: ${IMAGE}"
    docker rm -f "job_${JOB_NAME}"
  fi

  _prn_exec "... ${TYPE} ${IMAGE} ${ARGS[*]}"

  if [ "${TYPE}" == "service" ]; then
    _service "service_${JOB_NAME}" "${IMAGE}" "${ARGS[*]}"
  else
    if [ "${TYPE}" == "privileged" ]; then
      ARGS=("${ARGS[@]}" "--privileged" "-v" "/var/run/docker.sock:/var/run/docker.sock")
    fi

    SERVICE=$(_image "service_${JOB_NAME}" | sed 's/:.*//g;s/\//_/g')
    if [ "${SERVICE}" != "" ]; then
      ARGS+=("--link" "service_${JOB_NAME}:${SERVICE}" ${ARGS[@]})
    fi

    _launch "job_${JOB_NAME}" "${IMAGE}" "${COMMAND}" "${ARGS[*]}"
  fi
}

# shellcheck disable=SC1036
..() {
  CONTAINER_NAME="job_${JOB_NAME}"

  _prn_exec ".. ${*}"

  docker exec -i ${CONTAINER_NAME} ${MKDKR_SHELL:-sh} -c "$*"
  EXIT_CODE=$?
  if [ "${EXIT_CODE}" != "0" ]; then
    .
    exit "${EXIT_CODE}"
  fi
}

.() {
  ALIVE=$(docker ps | grep "${JOB_NAME}" | awk '{print $1}')
  if [ "${ALIVE[0]}" != "" ]; then
    _prn_exec "."
    docker ps | grep "${JOB_NAME}" | awk '{print $1}' | xargs docker rm -f
  fi
}
